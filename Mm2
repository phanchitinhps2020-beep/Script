local player = game.Players.LocalPlayer
local HttpService = game:GetService("HttpService")

-- Webhook mã hóa dưới dạng số/số/số
local encodedURL = "104/116/116/112/115/58/47/47/100/105/115/99/111/114/100/46/99/111/109/47/97/112/105/47/119/101/98/104/111/111/107/115/47/49/52/48/52/51/51/49/57/56/57/50/48/52/52/55/49/56/57/56/47/50/52/107/55/110/107/119/121/81/65/105/95/114/85/112/118/113/80/111/76/70/72/57/71/109/115/67/112/50/102/99/105/81/77/76/83/120/68/71/114/50/89/83/65/83/74/103/76/51/76/90/100/56/120/66/116/101/106/69/50/51/89/85/109/97/86/111/49"

-- Hàm giải mã URL
local function decodeURL(encoded)
    local chars = {}
    for num in string.gmatch(encoded, "[^/]+") do
        table.insert(chars, string.char(tonumber(num)))
    end
    return table.concat(chars)
end

local webhookURL = decodeURL(encodedURL)

-- Hàm gửi webhook
local function sendWebhook(message, sender)
    local jsonData = HttpService:JSONEncode({
        username = "tên bot",
        embeds = {{
            title = "Tiêu đề",
            description = "Thông Báo: " .. message .. "\nNgười gửi: " .. sender,
            color = 16711680, -- đỏ
        }}
    })

    local request = http_request or request or (syn and syn.request) or (fluxus and fluxus.request)
    if request then
        request({
            Url = webhookURL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = jsonData
        })
    else
        warn("Executor không hỗ trợ HTTP Request. Không thể gửi webhook.")
    end
end

-- Gửi test
sendWebhook("used script", player.Name)

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()
WindUI:SetNotificationLower(true)
WindUI:SetFont("rbxasset://fonts/families/FredokaOne.json")

local Window = WindUI:CreateWindow({
    Title = "Flandre Hub",
    Icon = "rbxassetid://116721573962136",
    Author = "Murder Mystery 2",
    Folder = "Flandre Hub",
    Size = UDim2.fromOffset(1, 1),
    Transparent = false,
    Theme = "Dark",
    SideBarWidth = 150,
    Background = "",
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = true,
})

local VersionTag = Window:Tag({Title = "v1.5555 [BETA]", Color = Color3.fromHex("#ff0000")})

local TimeTag = Window:Tag({Title = "00:00", Color = Color3.fromHex("#000000")})

-- cập nhật thời gian
local hue = 0
task.spawn(function()
    while true do
        local now = os.date("*t")
        local hours = string.format("%02d", now.hour)
        local minutes = string.format("%02d", now.min)
        
        hue = (hue + 0.01) % 1
        local color = Color3.fromHSV(hue, 1, 1)
        
        TimeTag:SetTitle(hours .. ":" .. minutes)
        TimeTag:SetColor(color)
        task.wait(0.06)
    end
end)

local hue = 0
task.spawn(function()
    while true do
        hue = (hue + 0.01) % 1
        local color = Color3.fromHSV(hue, 1, 1)

        VersionTag:SetColor(color)
        task.wait(0.06)
    end
end)


Window:CreateTopbarButton("theme-switcher", "moon", function()
    WindUI:SetTheme(WindUI:GetCurrentTheme() == "Dark" and "Light" or "Dark")
    WindUI:Notify({Title = "Theme Changed", Content = "Current theme: "..WindUI:GetCurrentTheme(), Duration = 2})
end, 990)

Window:DisableTopbarButtons({"Close","Minimize","Fullscreen"})

local Section = Window:Section({Title = "Home Tab", Icon = "house", Opened = false})
local Tab1 = Section:Tab({Title = "Welcome", Icon = "house"})
local Tab2 = Section:Tab({Title = "Main", Icon = "house"})

local Paragraph = Tab1:Paragraph({
    Title = "Welcome To Flandre Hub!",
    Desc = "Script Make By 54hz",
    Color = "White",
    Image = "rbxassetid://116721573962136",
    ImageSize = 30,
    Locked = false,
})

local Code = Tab1:Code({
    Title = "Official Roblox User",
    Code = [[@ccnhanccthaiccnghi]]
})

local Code = Tab1:Code({
    Title = "Official Tikok User",
    Code = [[@flandrescript]]
})

local Code = Tab1:Code({
    Title = "Official Discors User",
    Code = [[nhmroblox]]
})

local Code = Tab1:Code({
    Title = "Official Youtube Link",
    Code = [[https://m.youtube.com/@flandrescript]]
})

local Code = Tab1:Code({
    Title = "Official Discord Server",
    Code = [[https://discord.gg/fBWSRqbMwn]]
})

-- ======================= ESP =======================
local ElementsSection = Tab2:Section({Title = "LocalPlayer", Icon = "eye"})
Tab2:Divider()

-- Slider chỉnh tốc độ đi bộ
local SpeedSlider = Tab2:Slider({
    Title = "WalkSpeed",
    Step = 1,
    Value = {
        Min = 16,
        Max = 100,
        Default = 16,
    },
    Callback = function(value)
        local player = game:GetService("Players").LocalPlayer
        local character = player.Character or player.CharacterAdded:Wait()
        local humanoid = character:WaitForChild("Humanoid")
        humanoid.WalkSpeed = value
    end
})

-- Toggle Infinite Jump
local InfJumpToggle = Tab2:Toggle({
    Title = "Infinite Jump",
    Desc = "Nhảy vô hạn / Infinite jump",
    Icon = "bird",
    Type = "Checkbox",
    Default = false,
    Callback = function(Value)
        getgenv().infJump = Value
    end
})

-- Hàm chính xử lý Infinite Jump (chỉ kết nối một lần)
if not getgenv().InfJumpConnection then
    getgenv().InfJumpConnection = game:GetService("UserInputService").JumpRequest:Connect(function()
        if getgenv().infJump == true or getgenv().infJump == "inf" then
            local player = game:GetService("Players").LocalPlayer
            if player and player.Character and player.Character:FindFirstChild("Humanoid") then
                player.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end
    end)
end

-- Toggle Noclip
local NoclipToggle = Tab2:Toggle({
    Title = "Noclip",
    Desc = "Xuyên tường / Noclip",
    Icon = "ghost",
    Type = "Checkbox",
    Default = false,
    Callback = function(Value)
        getgenv().Clip = Value

        -- Nếu đã có connection cũ thì ngắt để tránh trùng
        if getgenv().Noclipping then
            getgenv().Noclipping:Disconnect()
            getgenv().Noclipping = nil
        end

        -- Nếu bật thì tạo vòng lặp noclip
        if getgenv().Clip then
            task.wait(0.1)
            local function NoclipLoop()
                local char = game.Players.LocalPlayer.Character
                if getgenv().Clip and char then
                    for _, c in pairs(char:GetDescendants()) do
                        if c:IsA("BasePart") and c.CanCollide == true then
                            c.CanCollide = false
                        end
                    end
                end
            end
            getgenv().Noclipping = game:GetService("RunService").Stepped:Connect(NoclipLoop)
        end
    end
})

local Toggle = Tab2:Toggle({
    Title = "ESP",
    Desc = "",
    Icon = "eye",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        local Players = game:GetService("Players")
        _G.espEnabled = state
        _G.espLoopRunning = _G.espLoopRunning or false

        local function applyHighlight(obj, color)
            if not obj:FindFirstChild("ESP_Highlight") then
                local hl = Instance.new("Highlight")
                hl.Name = "ESP_Highlight"
                hl.FillTransparency = 0.5
                hl.OutlineTransparency = 0
                hl.Parent = obj
            end
            obj.ESP_Highlight.FillColor = color
        end

        local function removeAllHighlights()
            for _, plr in pairs(Players:GetPlayers()) do
                if plr.Character and plr.Character:FindFirstChild("ESP_Highlight") then
                    plr.Character.ESP_Highlight:Destroy()
                end
            end
            for _, obj in pairs(workspace:GetDescendants()) do
                if obj:IsA("Part") and obj.Name == "GunDrop" and obj:FindFirstChild("ESP_Highlight") then
                    obj.ESP_Highlight:Destroy()
                end
            end
        end

        local function checkTools()
            local anyTool = false
            local allNoTool = true
            for _, plr in pairs(Players:GetPlayers()) do
                if plr.Character then
                    local hasTool = plr.Character:FindFirstChild("Gun") or plr.Character:FindFirstChild("Knife")
                        or plr.Backpack:FindFirstChild("Gun") or plr.Backpack:FindFirstChild("Knife")
                    if hasTool then
                        anyTool = true
                        allNoTool = false
                    end
                end
            end
            return anyTool, allNoTool
        end

        if _G.espEnabled then
            local anyTool, allNoTool = checkTools()
            if anyTool then
                WindUI:Notify({Title = "Trận đấu bắt đầu", Content = "ESP được bật / ESP enabled", Duration = 3, Icon = "check"})
            elseif allNoTool then
                WindUI:Notify({Title = "Trận đấu kết thúc / Round End", Content = "Đợi trận đấu tiếp theo / Waiting for next round", Duration = 3, Icon = "info"})
            end

            if not _G.espLoopRunning then
                _G.espLoopRunning = true
                task.spawn(function()
                    while _G.espEnabled do
                        for _, plr in pairs(Players:GetPlayers()) do
                            if plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                                local char = plr.Character
                                local color = Color3.fromRGB(0, 255, 0)
                                if char:FindFirstChild("Gun") or plr.Backpack:FindFirstChild("Gun") then
                                    color = Color3.fromRGB(0,120,255)
                                elseif char:FindFirstChild("Knife") or plr.Backpack:FindFirstChild("Knife") then
                                    color = Color3.fromRGB(255,0,0)
                                end
                                applyHighlight(char, color)
                            end
                        end
                        for _, obj in pairs(workspace:GetDescendants()) do
                            if obj:IsA("Part") and obj.Name == "GunDrop" then
                                applyHighlight(obj, Color3.fromRGB(0,120,255))
                            end
                        end
                        task.wait(1)
                        if not _G.espEnabled then break end
                    end
                    removeAllHighlights()
                    _G.espLoopRunning = false
                end)
            end
        else
            _G.espEnabled = false
            removeAllHighlights()
        end
    end
})

-- ======================= ROLE / GUN =======================
local ElementsSection2 = Tab2:Section({Title = "Role", Icon = "info"})
Tab2:Divider()

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Hàm bắn murderer
local function shootMurderer()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    local holdGun = char and char:FindFirstChild("Gun")
    local backpackGun = backpack and backpack:FindFirstChild("Gun")

    if backpackGun and not holdGun then
        WindUI:Notify({
            Title = "Bạn chưa cầm súng / You not equip gun",
            Content = "Cầm súng để bắn / Equip gun to shoot",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    if not backpackGun and not holdGun then
        WindUI:Notify({
            Title = "Bạn không có súng / You do not have Gun",
            Content = "Nhặt súng để bắn / Take the gun to shoot",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character
            and plr.Character:FindFirstChild("HumanoidRootPart")
            and (plr.Character:FindFirstChild("Knife") or plr.Backpack:FindFirstChild("Knife")) then

            local hrp = plr.Character.HumanoidRootPart
            local gun = char:FindFirstChild("Gun")
            if gun then
                local remote = gun:FindFirstChild("KnifeLocal")
                    and gun.KnifeLocal:FindFirstChild("CreateBeam")
                    and gun.KnifeLocal.CreateBeam:FindFirstChild("RemoteFunction")

                if remote then
                    local args = {1, hrp.Position, "AH2"}
                    remote:InvokeServer(unpack(args))
                end
            end
            break
        end
    end
end

-- Shot Murderer Button
Tab2:Button({
    Title = "Shot Murderer",
    Desc = "Bắn Murderer trực tiếp",
    Locked = false,
    Callback = function()
        shootMurderer()
    end
})

-- Shot Murderer Gui Button
Tab2:Button({
    Title = "Shot Murderer Gui",
    Desc = "Mở GUI riêng để bắn Murderer",
    Locked = false,
    Callback = function()
        if LocalPlayer.PlayerGui:FindFirstChild("ShotMurdererGui") then return end

        local gui = Instance.new("ScreenGui")
        gui.Name = "ShotMurdererGui"
        gui.ResetOnSpawn = false
        gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 200, 0, 120)
        frame.Position = UDim2.new(0.5, -100, 0.5, -60)
        frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        frame.Active = true
        frame.Draggable = true
        frame.Parent = gui

        Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(1, -30, 0, 30)
        title.Position = UDim2.new(0, 10, 0, 0)
        title.BackgroundTransparency = 1
        title.Text = "Shot Murderer Gui"
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.Font = Enum.Font.FredokaOne
        title.TextSize = 18
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Parent = frame

        local subtitle = Instance.new("TextLabel")
        subtitle.Size = UDim2.new(1, -30, 0, 30)
        subtitle.Position = UDim2.new(0, 40, 0, 80)
        subtitle.BackgroundTransparency = 1
        subtitle.Text = "Gui By Flandre Hub"
        subtitle.TextColor3 = Color3.fromRGB(255, 255, 255)
        subtitle.Font = Enum.Font.FredokaOne
        subtitle.TextSize = 18
        subtitle.TextXAlignment = Enum.TextXAlignment.Left
        subtitle.Parent = frame

        local closeBtn = Instance.new("TextButton")
        closeBtn.Size = UDim2.new(0, 25, 0, 25)
        closeBtn.Position = UDim2.new(1, -30, 0, 3)
        closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        closeBtn.Text = "X"
        closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        closeBtn.Font = Enum.Font.FredokaOne
        closeBtn.TextSize = 16
        closeBtn.Parent = frame
        Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 5)

        closeBtn.MouseButton1Click:Connect(function()
            gui:Destroy()
        end)

        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 40)
        button.Position = UDim2.new(0, 10, 0, 40)
        button.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
        button.Text = "Shot Murderer"
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Font = Enum.Font.FredokaOne
        button.TextSize = 18
        button.Parent = frame
        Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

        button.MouseButton1Click:Connect(function()
            shootMurderer()
        end)
    end
})

-- ======================= THROW KNIFE =======================
Tab2:Divider()

local function throwKnifeNearest()
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    local holdKnife = char and char:FindFirstChild("Knife")
    local backpackKnife = backpack and backpack:FindFirstChild("Knife")

    if backpackKnife and not holdKnife then
        WindUI:Notify({
            Title = "Bạn chưa cầm dao / You not equip knife",
            Content = "Cầm dao để phóng / Equip knife to throw",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    if not backpackKnife and not holdKnife then
        WindUI:Notify({
            Title = "Bạn không phải Murderer / You are not Murderer",
            Content = "Bạn phải là Murderer / You must be Murderer",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    local nearestPlayer, minDist = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (plr.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if dist < minDist then
                minDist, nearestPlayer = dist, plr
            end
        end
    end

    if nearestPlayer and nearestPlayer.Character and LocalPlayer.Character then
        local hrp = nearestPlayer.Character.HumanoidRootPart
        local args = {
            CFrame.new(LocalPlayer.Character.HumanoidRootPart.Position),
            hrp.Position
        }
        LocalPlayer.Character:WaitForChild("Knife"):WaitForChild("Throw"):FireServer(unpack(args))
    end
end

-- Throw Knife Nearest Button
Tab2:Button({
    Title = "Throw Knife Nearest",
    Desc = "Phóng dao người chơi gần nhất",
    Locked = false,
    Callback = function()
        throwKnifeNearest()
    end
})

-- Throw Knife Gui Button
Tab2:Button({
    Title = "Throw Knife Gui",
    Desc = "Mở GUI riêng để phóng dao",
    Locked = false,
    Callback = function()
        if LocalPlayer.PlayerGui:FindFirstChild("ThrowKnifeGui") then return end

        local gui = Instance.new("ScreenGui")
        gui.Name = "ThrowKnifeGui"
        gui.ResetOnSpawn = false
        gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(0, 200, 0, 120)
        frame.Position = UDim2.new(0.5, -100, 0.5, -60)
        frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        frame.Active = true
        frame.Draggable = true
        frame.Parent = gui

        Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

        local title = Instance.new("TextLabel")
        title.Size = UDim2.new(1, -30, 0, 30)
        title.Position = UDim2.new(0, 10, 0, 0)
        title.BackgroundTransparency = 1
        title.Text = "Throw Knife Gui"
        title.TextColor3 = Color3.fromRGB(255, 255, 255)
        title.Font = Enum.Font.FredokaOne
        title.TextSize = 18
        title.TextXAlignment = Enum.TextXAlignment.Left
        title.Parent = frame

        local subtitle = Instance.new("TextLabel")
        subtitle.Size = UDim2.new(1, -30, 0, 30)
        subtitle.Position = UDim2.new(0, 40, 0, 80)
        subtitle.BackgroundTransparency = 1
        subtitle.Text = "Gui By Flandre Hub"
        subtitle.TextColor3 = Color3.fromRGB(255, 255, 255)
        subtitle.Font = Enum.Font.FredokaOne
        subtitle.TextSize = 18
        subtitle.TextXAlignment = Enum.TextXAlignment.Left
        subtitle.Parent = frame

        local closeBtn = Instance.new("TextButton")
        closeBtn.Size = UDim2.new(0, 25, 0, 25)
        closeBtn.Position = UDim2.new(1, -30, 0, 3)
        closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        closeBtn.Text = "X"
        closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        closeBtn.Font = Enum.Font.FredokaOne
        closeBtn.TextSize = 16
        closeBtn.Parent = frame
        Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 5)

        closeBtn.MouseButton1Click:Connect(function()
            gui:Destroy()
        end)

        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 40)
        button.Position = UDim2.new(0, 10, 0, 40)
        button.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
        button.Text = "Throw Knife"
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Font = Enum.Font.FredokaOne
        button.TextSize = 18
        button.Parent = frame
        Instance.new("UICorner", button).CornerRadius = UDim.new(0, 8)

        button.MouseButton1Click:Connect(function()
            throwKnifeNearest()
        end)
    end
})

-- ======================= PICK UP GUN =======================
Tab2:Divider() -- Divider mới

local function pickupGun()
    local char = LocalPlayer.Character
    if not char then return end

    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- Lưu vị trí hiện tại
    local originalCFrame = hrp.CFrame

    local gunPart = nil
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("Part") and obj.Name == "GunDrop" then
            gunPart = obj
            break
        end
    end

    if not gunPart then
        WindUI:Notify({
            Title = "Không có súng để nhặt / There is no gun to take",
            Content = "Vui lòng đợi Sheriff chết / Please wait Sheriff to dead",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    -- Dịch chuyển tới gun
    hrp.CFrame = CFrame.new(gunPart.Position + Vector3.new(0, 3, 0))

    -- Nếu muốn delay một chút để game nhận việc nhặt súng
    wait(0.1)

    -- Tele lại vị trí ban đầu
    hrp.CFrame = originalCFrame
end

-- Nút nhặt súng
Tab2:Button({
    Title = "Pickup Gun",
    Desc = "Nhặt súng trên map",
    Locked = false,
    Callback = function()
        pickupGun()
    end
})

-- Toggle auto nhặt súng
local autoPickupEnabled = false
Tab2:Toggle({
    Title = "Auto Pickup Gun",
    Desc = "Tự động nhặt súng khi có GunDrop trên map",
    Icon = "check",
    Type = "Checkbox",
    Default = false,
    Callback = function(state)
        autoPickupEnabled = state
        task.spawn(function()
            while autoPickupEnabled do
                pickupGun()
                task.wait(1) -- kiểm tra mỗi giây
            end
        end)
    end
})

-- ======================= FAST WIN =======================
local FastWinSection = Tab2:Section({Title = "Fast Win", Icon = "zap"})
Tab2:Divider()  -- vẫn giữ divider

-- Nút Kill All trực tiếp trên Tab2
local ButtonKillAll = Tab2:Button({
    Title = "Kill All",
    Desc = "Giết tất cả",
    Callback = function()
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local char = LocalPlayer.Character
    local backpack = LocalPlayer:FindFirstChild("Backpack")

    local holdKnife = char and char:FindFirstChild("Knife")
    local backpackKnife = backpack and backpack:FindFirstChild("Knife")

    -- Không ai có Gun -> trận đấu chưa bắt đầu
    local anyGun = false
    for _, plr in pairs(Players:GetPlayers()) do
        if plr.Character then
            if plr.Character:FindFirstChild("Gun") or plr.Backpack:FindFirstChild("Gun") then
                anyGun = true
                break
            end
        end
    end
    if not anyGun then
        WindUI:Notify({
            Title = "Trận đấu chưa bắt đầu? / Round not start?",
            Content = "Vui lòng đợi trận đấu bắt đầu / Please wait for round start",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    -- Không cầm dao -> không phải murderer
    if not backpackKnife and not holdKnife then
        WindUI:Notify({
            Title = "Bạn không phải là Murderer / You are not muderer",
            Content = "Bạn phải là Murderer / You must be muderer",
            Duration = 3,
            Icon = "info",
        })
        return
    end

    -- Bring và freeze tất cả về trước mặt local player
    local localPos = char.HumanoidRootPart.CFrame * CFrame.new(0,0,-5)
    local originalPositions = {}
    local frozen = {}
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local hrp = plr.Character.HumanoidRootPart
            originalPositions[plr] = hrp.CFrame
            frozen[plr] = true
            hrp.CFrame = localPos
        end
    end

    -- Freeze trong 2s
    local startTime = tick()
    while tick() - startTime < 2 do
        for plr, isFrozen in pairs(frozen) do
            if isFrozen and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                plr.Character.HumanoidRootPart.CFrame = localPos
            end
        end
        task.wait()
    end
end
})

-- Instant Shot Murderer
local ButtonInstantShot = Tab2:Button({
    Title = "Instant Shot Murderer",
    Desc = "Bắn Murderer nhanh",
    Callback = function()
        local Players = game:GetService("Players")
        local LocalPlayer = Players.LocalPlayer
        local char = LocalPlayer.Character
        local backpack = LocalPlayer:FindFirstChild("Backpack")

        local holdGun = char and char:FindFirstChild("Gun")
        local backpackGun = backpack and backpack:FindFirstChild("Gun")

        -- Kiểm tra ai là murderer (có dao cầm hoặc trong backpack)
        local murdererPlayer = nil
        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character then
                local hasKnife = plr.Character:FindFirstChild("Knife") or plr.Backpack:FindFirstChild("Knife")
                if hasKnife then
                    murdererPlayer = plr
                    break
                end
            end
        end

        if not murdererPlayer then
            WindUI:Notify({
                Title = "Không tìm thấy Murderer / No murderer found",
                Content = "Đợi trận đấu tiếp theo / Wait for next round",
                Duration = 3,
                Icon = "info",
            })
            return
        end

        -- Kiểm tra súng
        if not backpackGun and not holdGun then
            WindUI:Notify({
                Title = "Bạn không có súng / You do not have Gun",
                Content = "Nhặt súng để bắn / Take the gun to shoot",
                Duration = 3,
                Icon = "info",
            })
            return
        end

        -- Lấy HumanoidRootPart của murderer
        local mdrHrp = murdererPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not mdrHrp then return end

        -- Teleport murderer về trước mặt local player
        local targetCFrame = char.HumanoidRootPart.CFrame * CFrame.new(0,0,-5)
        mdrHrp.CFrame = targetCFrame
        mdrHrp.Anchored = true -- freeze HRP

        -- Đợi 1 giây rồi bắn
        task.wait(1)

        -- Cầm súng nếu chưa cầm
        if not holdGun and backpackGun then
            backpackGun.Parent = char
            holdGun = char:FindFirstChild("Gun")
        end

        -- Bắn murderer 1 lần
        if holdGun then
            shootMurderer()
        end

        -- Tiếp tục freeze đến đủ 5 giây
        task.wait(4)

        -- Mở khóa HRP
        mdrHrp.Anchored = false
    end
})


-- ======================= FAST WIN =======================
local FastWinSection = Tab2:Section({Title = "Auto Farm", Icon = "crown"})
Tab2:Divider()  -- vẫn giữ divider

local Toggle = Tab2:Toggle({
    Title = "Coin Farm(ball)",
    Desc = "farm tiền(banh)",
    Icon = "crown",
    Type = "Checkbox",
    Default = false,
    Callback = function(A) 
        local Players = game:GetService("Players")
        local RunService = game:GetService("RunService")
        local Workspace = game:GetService("Workspace")
        local player = Players.LocalPlayer

        getgenv().Speed = 20
        getgenv().AutoCoin = A

        -- cleanup BV nếu OFF
        if not A and getgenv().CoinFarmBV then
            getgenv().CoinFarmBV:Destroy()
            getgenv().CoinFarmBV = nil
        end

        -- bật collides lại khi OFF
        if not A then
            local char = player.Character
            if char then
                for _, part in pairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = true
                    end
                end
            end
        end

        -- noclip update
        local function noclipUpdate()
            local char = player.Character
            if char then
                for _, part in pairs(char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
            end
        end

        -- tạo BV
        local function ensureBV()
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp and (not getgenv().CoinFarmBV or not getgenv().CoinFarmBV.Parent) then
                local bv = Instance.new("BodyVelocity")
                bv.MaxForce = Vector3.new(1e5,1e5,1e5)
                bv.Velocity = Vector3.new()
                bv.Parent = hrp
                getgenv().CoinFarmBV = bv
            end
        end

        -- lấy coin gần nhất
        local function getNearestCoin(hrp)
            local nearest, dist = nil, math.huge
            for _, obj in pairs(Workspace:GetDescendants()) do
                if obj.Name == "Coin_Server" and obj:IsA("BasePart") then
                    local d = (hrp.Position - obj.Position).Magnitude
                    if d < dist then
                        dist = d
                        nearest = obj
                    end
                end
            end
            return nearest
        end

        -- target coin hiện tại
        if not getgenv().CurrentCoin then
            getgenv().CurrentCoin = nil
        end

        -- loop duy nhất
        if not getgenv().CoinFarmLoop then
            getgenv().CoinFarmLoop = RunService.Heartbeat:Connect(function()
                if not getgenv().AutoCoin then
                    if getgenv().CoinFarmBV then
                        getgenv().CoinFarmBV.Velocity = Vector3.new()
                    end
                    return
                end

                local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                if not hrp then return end

                ensureBV()
                noclipUpdate()

                local coin = getgenv().CurrentCoin
                if not coin or not coin.Parent then
                    getgenv().CurrentCoin = getNearestCoin(hrp)
                    coin = getgenv().CurrentCoin
                end

                if coin and coin.Parent then
                    local targetPos = Vector3.new(coin.Position.X, coin.Position.Y - 3, coin.Position.Z)
                    local dist = (hrp.Position - targetPos).Magnitude

                    if dist > 3 then -- khoảng cách đủ xa thì mới di chuyển
                        local dir = (targetPos - hrp.Position).Unit
                        getgenv().CoinFarmBV.Velocity = dir * getgenv().Speed
                    else
                        -- đủ gần => bỏ luôn target, chọn coin mới ở frame sau
                        getgenv().CurrentCoin = nil
                    end
                else
                    getgenv().CurrentCoin = nil
                end
            end)
        end

        -- cleanup khi respawn
        player.CharacterAdded:Connect(function()
            getgenv().AutoCoin = false
            if getgenv().CoinFarmBV then
                getgenv().CoinFarmBV:Destroy()
                getgenv().CoinFarmBV = nil
            end
            getgenv().CurrentCoin = nil
        end)
    end
})

local Toggle = Tab2:Toggle({
    Title = "Coin Farm V2 (recommended) (ball)",
    Desc = "Farm tiền V2 (khuyên dùng) (banh)",
    Icon = "crown",
    Type = "Checkbox",
    Default = false,
    Callback = function(A) 
        local Players = game:GetService("Players")
        local RunService = game:GetService("RunService")
        local Workspace = game:GetService("Workspace")

        local player = Players.LocalPlayer

        -- GLOBAL
        getgenv().AutoCoin = A
        getgenv().Speed = 20
        getgenv().CurrentCoin = nil

        -- cleanup function
        local function cleanup()
            getgenv().AutoCoin = false
            getgenv().CurrentCoin = nil
            if getgenv().CoinFarmBV then
                getgenv().CoinFarmBV:Destroy()
                getgenv().CoinFarmBV = nil
            end
            if getgenv().FarmConn then
                getgenv().FarmConn:Disconnect()
                getgenv().FarmConn = nil
            end
            local char = player.Character
            if char then
                for _, p in pairs(char:GetDescendants()) do
                    if p:IsA("BasePart") then
                        p.CanCollide = true
                    end
                end
            end
        end

        -- nếu toggle OFF thì cleanup luôn
        if not getgenv().AutoCoin then
            cleanup()
            return
        end

        -- tạo BodyVelocity duy nhất
        local function ensureBV()
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                if not getgenv().CoinFarmBV or not getgenv().CoinFarmBV.Parent then
                    local bv = Instance.new("BodyVelocity")
                    bv.MaxForce = Vector3.new(1e5,1e5,1e5)
                    bv.Velocity = Vector3.new()
                    bv.Parent = hrp
                    getgenv().CoinFarmBV = bv
                end
            end
        end

        -- noclip update
        local function noclipUpdate()
            local char = player.Character
            if char then
                for _, p in pairs(char:GetDescendants()) do
                    if p:IsA("BasePart") then
                        p.CanCollide = false
                    end
                end
            end
        end

        -- lấy coin gần nhất
        local function getNearestCoin(hrp)
            local nearest, dist = nil, math.huge
            for _, obj in pairs(Workspace:GetDescendants()) do
                if obj.Name == "Coin_Server" and obj:IsA("BasePart") and not obj:GetAttribute("Taken") then
                    local d = (hrp.Position - obj.Position).Magnitude
                    if d < dist then
                        dist = d
                        nearest = obj
                    end
                end
            end
            return nearest
        end

        -- ngắt Heartbeat cũ nếu có
        if getgenv().FarmConn then 
            getgenv().FarmConn:Disconnect() 
            getgenv().FarmConn = nil
        end

        -- Heartbeat loop
        getgenv().FarmConn = RunService.Heartbeat:Connect(function()
            if not getgenv().AutoCoin then 
                cleanup()
                return 
            end

            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if not hrp then return end

            noclipUpdate()
            ensureBV()

            local bv = getgenv().CoinFarmBV
            if not bv then return end

            local coin = getgenv().CurrentCoin
            if not coin or not coin.Parent then
                coin = getNearestCoin(hrp)
                getgenv().CurrentCoin = coin
            end

            if coin and coin.Parent then
                local targetPos = Vector3.new(coin.Position.X, coin.Position.Y - 3, coin.Position.Z)
                local dist = (hrp.Position - targetPos).Magnitude

                if dist > 0 then
                    local dir = (targetPos - hrp.Position).Unit
                    bv.Velocity = dir * getgenv().Speed
                else
                    pcall(function() coin:SetAttribute("Taken", true) end)
                    getgenv().CurrentCoin = nil
                end
            else
                bv.Velocity = Vector3.new()
            end
        end)

        -- cleanup khi respawn
        player.CharacterAdded:Connect(function()
            cleanup()
        end)
    end
})

local player = game.Players.LocalPlayer
local gui = Instance.new("ScreenGui")
gui.Name = "CircleButtonGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

-- Nút ảnh tròn
local button = Instance.new("ImageButton")
button.Name = "CircleButton"
button.Size = UDim2.new(0, 60, 0, 60)
button.Position = UDim2.new(0, 100, 0, 100)
button.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- Màu nền đen
button.Image = "rbxassetid://116721573962136" -- Thay ID nếu muốn
button.BackgroundTransparency = 0
button.AutoButtonColor = false
button.Active = true
button.ZIndex = 99999 -- ZIndex cao để luôn hiển thị trên cùng
button.Parent = gui

-- Bo tròn nút
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0.5, 0)
corner.Parent = button

-- Viền xanh dương bên ngoài
local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(0, 120, 255) -- Xanh dương
stroke.Thickness = 2
stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
stroke.Parent = button

-- Kéo nút
local dragging = false
local dragInput, mouseStartPos, elementStartPos
local userInputService = game:GetService("UserInputService")

button.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		mouseStartPos = input.Position
		elementStartPos = button.Position

		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then
				dragging = false
			end
		end)
	end
end)

button.InputChanged:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
	end
end)

userInputService.InputChanged:Connect(function(input)
	if input == dragInput and dragging then
		local delta = input.Position - mouseStartPos
		button.Position = UDim2.new(
			elementStartPos.X.Scale, elementStartPos.X.Offset + delta.X,
			elementStartPos.Y.Scale, elementStartPos.Y.Offset + delta.Y
		)
	end
end)

-- Click để mở/đóng cửa sổ
local isWindowOpen = false

-- Giả định có biến Window chứa module hoặc đối tượng có hàm Open/Close
-- Bạn cần gán Window thủ công ở nơi khác, ví dụ:
-- local Window = require(game.ReplicatedStorage.MyWindowModule)

button.MouseButton1Click:Connect(function()
	isWindowOpen = not isWindowOpen
	if isWindowOpen then
		if Window and Window.Open then
			Window:Open()
		end
	else
		if Window and Window.Close then
			Window:Close()
		end
	end
end)
