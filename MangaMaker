local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local req = request or http_request or (syn and syn.request)
local getasset = getcustomasset or getsynasset

local MangaMaker = {}
MangaMaker.Windows = {}

function MangaMaker:CreateWindow(title)
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = title or "MangaWindow"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    -- Main frame full screen
    local main = Instance.new("Frame")
    main.Parent = screenGui
    main.AnchorPoint = Vector2.new(0.5,0.5)
    main.Position = UDim2.new(0.5,0,0.5,0)
    main.Size = UDim2.new(1,0,1,0)
    main.BackgroundColor3 = Color3.fromRGB(60,60,60)
    main.BackgroundTransparency = 0.5
    main.ClipsDescendants = true
    main.Active = true
    main.Draggable = false

    -- Tên window góc trái, ZIndex = 2
    local label = Instance.new("TextLabel", main)
    label.ZIndex = 2
    label.Size = UDim2.new(0.2,0,0.05,0)
    label.Position = UDim2.new(0,10,0,10)
    label.BackgroundTransparency = 1
    label.Text = title or "Manga"
    label.TextColor3 = Color3.new(1,1,1)
    label.TextScaled = true
    label.TextXAlignment = Enum.TextXAlignment.Left

    -- Nút X góc phải, ZIndex = 2
    local close = Instance.new("TextButton", main)
    close.ZIndex = 2
    close.Size = UDim2.new(0.05,0,0.05,0)
    close.Position = UDim2.new(1,-10,0,10)
    close.AnchorPoint = Vector2.new(1,0)
    close.Text = "X"
    close.BackgroundColor3 = Color3.fromRGB(200,0,0)
    close.TextColor3 = Color3.new(1,1,1)
    close.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    -- ScrollFrame ngang
    local scroll = Instance.new("ScrollingFrame", main)
    scroll.AnchorPoint = Vector2.new(0,0)
    scroll.Position = UDim2.new(0,0,0,0)
    scroll.Size = UDim2.new(1,0,1,0)
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 10
    scroll.CanvasSize = UDim2.new(0,0,0,0)
    scroll.HorizontalScrollBarInset = Enum.ScrollBarInset.Always
    scroll.VerticalScrollBarInset = Enum.ScrollBarInset.None
    scroll.ClipsDescendants = true

    local layout = Instance.new("UIListLayout", scroll)
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.Padding = UDim.new(0,10) -- khoảng cách 10px
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    layout.VerticalAlignment = Enum.VerticalAlignment.Center
    layout.SortOrder = Enum.SortOrder.LayoutOrder

    local window = {}
    window.Scroll = scroll
    window._images = {}
    window._count = 0

    function window:AddImage(link)
        local final = link
        if link:find("http") then
            if not req then warn("Executor không hỗ trợ request") return end
            local file = "Manga_"..os.time().."_"..math.random(9999)..".png"
            local d = req({Url=link, Method="GET"})
            if d.StatusCode == 200 then
                writefile(file,d.Body)
                final = getasset(file)
            else
                warn("Không tải được link:", link)
            end
        end

        local frame = Instance.new("Frame", scroll)
        frame.BackgroundTransparency = 1

        -- Chiều ngang = 80% chiều cao GUI
        local guiHeight = main.AbsoluteSize.Y
        local imgWidth = guiHeight * 0.8

        local img = Instance.new("ImageLabel", frame)
        img.Image = final
        img.BackgroundTransparency = 1
        img.Size = UDim2.new(1,0,1,0)
        img.ScaleType = Enum.ScaleType.Fit
        img.Rotation = -90

        table.insert(window._images, frame)
        window._count += 1

        local function UpdateFrame()
            local conn
            conn = img:GetPropertyChangedSignal("ImageRectSize"):Connect(function()
                local w,h = img.ImageRectSize.X,img.ImageRectSize.Y
                if w > 0 and h > 0 then
                    local ratio = h / w
                    local newWidth = imgWidth
                    local newHeight = newWidth * ratio
                    frame.Size = UDim2.new(0,newWidth,0,newHeight)

                    -- Cập nhật CanvasSize
                    local totalWidth = 0
                    for _,f in pairs(window._images) do
                        totalWidth = totalWidth + f.AbsoluteSize.X
                    end
                    totalWidth = totalWidth + layout.Padding.Offset * (window._count - 1)
                    scroll.CanvasSize = UDim2.new(0,totalWidth,0,scroll.AbsoluteSize.Y)

                    conn:Disconnect()
                end
            end)
        end

        task.defer(UpdateFrame)
        return img
    end

    table.insert(self.Windows, window)
    return window
end

return MangaMaker
