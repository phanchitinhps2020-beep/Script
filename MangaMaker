local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local req = request or http_request or (syn and syn.request)
local getasset = getcustomasset or getsynasset

local MangaMaker = {}
MangaMaker.Windows = {}

function MangaMaker:CreateWindow(title)
    title = title or "MangaWindow"

    -- Lấy size màn hình
    local screenX = workspace.CurrentCamera.ViewportSize.X
    local screenY = workspace.CurrentCamera.ViewportSize.Y

    -- Chiều dọc mặc định
    local guiHeight = screenY*0.8
    local guiWidth = guiHeight*0.6  -- dọc = chiều cao lớn, chiều ngang nhỏ hơn

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = title
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    local main = Instance.new("Frame")
    main.Parent = screenGui
    main.Size = UDim2.new(0, guiWidth, 0, guiHeight)
    main.Position = UDim2.new(0.5, -guiWidth/2, 0.5, -guiHeight/2)
    main.BackgroundColor3 = Color3.fromRGB(60,60,60)
    main.BackgroundTransparency = 0.5
    main.Active = true
    main.Draggable = true

    -- Nút X đóng
    local close = Instance.new("TextButton", main)
    close.Size = UDim2.new(0,25,0,25)
    close.Position = UDim2.new(1,-30,0,5)
    close.Text = "X"
    close.BackgroundColor3 = Color3.fromRGB(200,0,0)
    close.TextColor3 = Color3.new(1,1,1)
    close.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    -- Nút <> đổi chiều
    local rotate = Instance.new("TextButton", main)
    rotate.Size = UDim2.new(0,25,0,25)
    rotate.Position = UDim2.new(1,-30,0,35)
    rotate.Text = "<>"
    rotate.BackgroundColor3 = Color3.fromRGB(0,150,255)
    rotate.TextColor3 = Color3.new(1,1,1)

    -- Scroll frame
    local scroll = Instance.new("ScrollingFrame", main)
    scroll.Size = UDim2.new(0.95,0,0.88,0)
    scroll.Position = UDim2.new(0.025,0,0.1,0)
    scroll.ScrollBarThickness = 6
    scroll.BackgroundTransparency = 1
    scroll.CanvasSize = UDim2.new(0,0,0,0)

    local layout = Instance.new("UIListLayout", scroll)
    layout.Padding = UDim.new(0,5)
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    local window = {}
    window.Scroll = scroll
    window._count = 0
    window._height = 200
    window._main = main
    window._isVertical = true

    -- AddImage
    function window:AddImage(link)
        local final = link
        if link:find("http") then
            if not req then return warn("Executor không hỗ trợ request") end
            local file = "Manga_"..os.time().."_"..math.random(9999)..".png"
            local d = req({Url=link, Method="GET"})
            if d.StatusCode == 200 then
                writefile(file,d.Body)
                final = getasset(file)
            else
                warn("Không tải được link:", link)
            end
        end

        local frame = Instance.new("Frame",scroll)
        frame.Size = UDim2.new(0.8,0,0,window._height)
        frame.BackgroundTransparency = 1

        local img = Instance.new("ImageLabel", frame)
        img.Size = UDim2.new(1,0,1,0)
        img.BackgroundTransparency = 1
        img.ScaleType = Enum.ScaleType.Fit
        img.Image = final

        window._count += 1
        scroll.CanvasSize = UDim2.new(0,0,0,window._count*(window._height+5))
        return img
    end

    -- Click nút <> để thay đổi chiều
    rotate.MouseButton1Click:Connect(function()
        local screenX = workspace.CurrentCamera.ViewportSize.X
        local screenY = workspace.CurrentCamera.ViewportSize.Y
        if window._isVertical then
            -- chuyển sang ngang (full width, nhỏ height)
            window._main.Size = UDim2.new(0, screenX*0.8, 0, screenY*0.5)
            window._main.Position = UDim2.new(0.5, -screenX*0.4, 0.5, -screenY*0.25)
        else
            -- chuyển về dọc
            window._main.Size = UDim2.new(0, screenY*0.6, 0, screenY*0.8)
            window._main.Position = UDim2.new(0.5, -screenY*0.3, 0.5, -screenY*0.4)
        end
        window._isVertical = not window._isVertical
    end)

    table.insert(self.Windows, window)
    return window
end

return MangaMaker
