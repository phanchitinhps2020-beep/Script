local player = game.Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local req = request or http_request or (syn and syn.request)
local getasset = getcustomasset or getsynasset

local MangaMaker = {}
MangaMaker.Windows = {}

-- Hàm tạo window với AutoScale
function MangaMaker:CreateWindow(title)
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = title or "MangaWindow"
    screenGui.Parent = playerGui
    screenGui.ResetOnSpawn = false

    -- Mặc định dọc
    local orientation = "Vertical" 

    local main = Instance.new("Frame")
    main.Parent = screenGui
    main.AnchorPoint = Vector2.new(0.5,0.5)
    main.Position = UDim2.new(0.5,0,0.5,0)
    main.Size = UDim2.new(0.5,0,0.7,0)
    main.BackgroundColor3 = Color3.fromRGB(60,60,60)
    main.BackgroundTransparency = 0.5
    main.Active = true
    main.ClipsDescendants = true
    main.Draggable = true

    -- Nút đóng
    local close = Instance.new("TextButton", main)
    close.Size = UDim2.new(0.05,0,0.05,0)
    close.Position = UDim2.new(0.95,0,0,0)
    close.AnchorPoint = Vector2.new(1,0)
    close.Text = "X"
    close.BackgroundColor3 = Color3.fromRGB(200,0,0)
    close.TextColor3 = Color3.new(1,1,1)
    close.MouseButton1Click:Connect(function()
        screenGui:Destroy()
    end)

    -- ScrollFrame
    local scroll = Instance.new("ScrollingFrame", main)
    scroll.AnchorPoint = Vector2.new(0.5,0)
    scroll.Position = UDim2.new(0.5,0,0.05,0)
    scroll.Size = UDim2.new(0.95,0,0.9,0)
    scroll.ScrollBarThickness = 6
    scroll.BackgroundTransparency = 1
    scroll.CanvasSize = UDim2.new(0,0,0,0)
    
    local layout = Instance.new("UIListLayout", scroll)
    layout.Padding = UDim.new(0,5)
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center

    -- Nút đổi hướng
    local rotate = Instance.new("TextButton", main)
    rotate.Size = UDim2.new(0.05,0,0.05,0)
    rotate.Position = UDim2.new(0.9,0,0,0)
    rotate.Text = "<>"
    rotate.TextColor3 = Color3.new(1,1,1)
    rotate.BackgroundColor3 = Color3.fromRGB(0,150,0)

    local window = {}
    window.Scroll = scroll
    window._count = 0
    window._orientation = orientation

    -- Function add image
    function window:AddImage(link)
        local final = link
        if link:find("http") then
            if not req then warn("Executor không hỗ trợ request") return end
            local file = "Manga_"..os.time().."_"..math.random(9999)..".png"
            local d = req({Url=link,Method="GET"})
            if d.StatusCode == 200 then
                writefile(file,d.Body)
                final = getasset(file)
            else
                warn("Không tải được link:", link)
            end
        end

        local frame = Instance.new("Frame", scroll)
        frame.Size = UDim2.new(0.9,0,0,0.2) -- 20% height dọc (sẽ scale tự động)
        frame.BackgroundTransparency = 1

        local img = Instance.new("ImageLabel", frame)
        img.Size = UDim2.new(1,0,1,0)
        img.BackgroundTransparency = 1
        img.ScaleType = Enum.ScaleType.Fit
        img.Image = final

        window._count += 1
        -- AutoScale canvas theo orientation
        if window._orientation == "Vertical" then
            scroll.CanvasSize = UDim2.new(0,0,0.2*window._count + 0.01,0)
            layout.FillDirection = Enum.FillDirection.Vertical
        else
            scroll.CanvasSize = UDim2.new(0.25*window._count + 0.01,0,0,0)
            layout.FillDirection = Enum.FillDirection.Horizontal
        end

        return img
    end

    -- Xử lý xoay hướng
    rotate.MouseButton1Click:Connect(function()
        if window._orientation == "Vertical" then
            window._orientation = "Horizontal"
            layout.FillDirection = Enum.FillDirection.Horizontal
        else
            window._orientation = "Vertical"
            layout.FillDirection = Enum.FillDirection.Vertical
        end
        -- Cập nhật lại CanvasSize
        if window._orientation == "Vertical" then
            scroll.CanvasSize = UDim2.new(0,0,0.2*window._count + 0.01,0)
        else
            scroll.CanvasSize = UDim2.new(0.25*window._count + 0.01,0,0,0)
        end
    end)

    table.insert(self.Windows, window)
    return window
end

return MangaMaker
